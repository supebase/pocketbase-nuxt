# PocketBase-Nuxt

## 1. 概述

PocketBase-Nuxt 是一个全栈 Web 应用程序，它结合了现代 Nuxt.js 4 框架与 PocketBase 后端即服务（BaaS），提供了一个功能丰富的具有实时能力的社交内容平台。该项目展示了身份验证、内容管理、实时同步和响应式 UI 开发的生产就绪模式。

## 2. 架构概览

该应用程序遵循清晰的关注点分离原则，采用了面向服务的架构。前端利用 Nuxt.js 进行服务端渲染和客户端注水，而 PocketBase 提供后端数据库、身份验证和实时订阅服务。

## 3. 核心功能

### 3.1 身份验证系统

该应用程序使用存储在安全 Cookie 中的 JWT 令牌实现了全面的身份验证流程。身份验证系统支持用户注册、登录、登载和电子邮件验证，并包含地理位置跟踪。会话管理通过 nuxt-auth-utils 处理，支持可配置的密码保护和会话持续时间（默认 7 天）。

### 3.2 内容管理

该平台为支持 Markdown 的帖子提供完整的 CRUD 操作。帖子可以包含嵌入图片、代码块和外部链接的丰富内容。系统会自动处理远程图片，将其下载到本地服务器，并更新引用。内容的可见性通过已发布/未发布状态进行控制，草稿访问仅限于经过验证的作者。

### 3.3 实时更新

强大的服务器发送事件（SSE）实现支持跨所有客户端的实时同步。该系统使用指数退避策略（1s, 2s, 4s, 8s, 16s, 最大 30s）维持持久连接并自动重连。心跳包（每 20 秒）保持连接活跃，并检测断开连接以便立即清理。

```
实时订阅系统使用统一的清理机制，处理多种场景：客户端发起的断开连接、服务器连接丢失和应用程序关闭，确保没有内存泄漏或孤立连接。
```

## 4. 关键架构决策

### 4.1 类型化 PocketBase 集成

该项目使用从 PocketBase 集合自动生成的 TypeScript 类型，为所有数据库操作提供编译时类型安全。TypedPocketBase 实例确保集合名称、字段名称和数据结构在构建时得到验证，从而消除了运行时错误的常见来源。

### 4.2 服务层模式

业务逻辑封装在接收 PocketBase 实例作为参数的服务层函数中。这种依赖注入模式确保身份验证上下文（用户凭据）由 API 路由控制，而服务则纯粹专注于数据操作。这种分离提高了可测试性和可复用性。

### 4.3 Composables 状态管理

前端状态管理依赖于 Vue 3 组合式 API，通过领域特定的 composables 实现。每个 composable 管理自己的响应式状态，公开数据获取、变更和实时同步的方法。与 Options API 相比，这种方法提供了更好的代码组织和更轻松的跨组件状态共享。

```
分页系统实现了带有实时更新的无限滚动，来自其他用户的新帖子会自动插入，同时保持当前的滚动位置，创造无缝的浏览体验。
```

## 5. 性能优化

- 构建优化：以 ESNext 为目标的 ESBuild，Lightning CSS 压缩，以及生产环境禁用 source maps
- Payload 提取：在悬停链接时启用路由预取
- 异步上下文：在异步操作中处理稳定的全局状态
- 图标优化：基于 CDN 的图标加载，仅扫描客户端使用的图标
- 资源压缩：公共资源的 Brotli 和 Gzip 压缩
- 路由 Keep-alive：在内存中最多保留 10 个路由实例以加快导航速度
